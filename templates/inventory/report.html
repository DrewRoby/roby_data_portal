{% extends "inventory/base.html" %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'portal:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
<li class="breadcrumb-item active">Reports</li>
{% endblock %}

{% block inventory_title %}Inventory Reports{% endblock %}

{% block inventory_content %}
<div class="row">
    <!-- Report Selection -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Report Options</h5>
            </div>
            <div class="card-body">
                <form method="get" id="report-form">
                    <div class="mb-3">
                        <label for="id_report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="id_report_type" name="report_type">
                            <option value="inventory_summary" {% if report_type == 'inventory_summary' %}selected{% endif %}>Inventory Summary</option>
                            <option value="low_stock" {% if report_type == 'low_stock' %}selected{% endif %}>Low Stock Items</option>
                            <option value="warehouse_status" {% if report_type == 'warehouse_status' %}selected{% endif %}>Warehouse Status</option>
                            <option value="item_distribution" {% if report_type == 'item_distribution' %}selected{% endif %}>Item Distribution</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_warehouse" class="form-label">Warehouse</label>
                        <select class="form-select" id="id_warehouse" name="warehouse">
                            <option value="all">All Warehouses</option>
                            {% for w in warehouses %}
                                <option value="{{ w.id }}" {% if warehouse_id == w.id %}selected{% endif %}>{{ w.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa fa-sync"></i> Generate Report
                    </button>
                </form>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary" id="btn-export-pdf">
                        <i class="fa fa-file-pdf"></i> Export as PDF
                    </button>
                    <button class="btn btn-outline-secondary" id="btn-export-csv">
                        <i class="fa fa-file-csv"></i> Export as CSV
                    </button>
                    <button class="btn btn-outline-secondary" id="btn-print">
                        <i class="fa fa-print"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Content -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ report_title }}</h5>
                <span class="text-muted">Generated: {{ generation_time }}</span>
            </div>
            <div class="card-body">
                <div id="report-container">
                
                    {% if report_type == 'inventory_summary' %}
                        <!-- Inventory Summary Report -->
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3>{{ total_items }}</h3>
                                        <p class="mb-0">Total Items</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3>{{ total_quantity }}</h3>
                                        <p class="mb-0">Total Quantity</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3>{{ total_bins }}</h3>
                                        <p class="mb-0">Total Bins</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6>Items by Warehouse</h6>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Warehouse</th>
                                        <th>Items</th>
                                        <th>Total Quantity</th>
                                        <th>Racks</th>
                                        <th>Shelves</th>
                                        <th>Bins</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for w in warehouse_data %}
                                    <tr>
                                        <td>{{ w.name }}</td>
                                        <td>{{ w.items }}</td>
                                        <td>{{ w.quantity }}</td>
                                        <td>{{ w.racks }}</td>
                                        <td>{{ w.shelves }}</td>
                                        <td>{{ w.bins }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <h6>Most Stocked Items</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Quantity</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_items %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.sku|default:'N/A' }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>{{ item.location }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                    
                    {% if report_type == 'low_stock' %}
                        <!-- Low Stock Report -->
                        <div class="alert alert-warning mb-4">
                            <i class="fa fa-exclamation-triangle"></i> 
                            There are <strong>{{ low_stock_count }}</strong> items with low stock levels.
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th>SKU</th>
                                        <th>Current Quantity</th>
                                        <th>Min. Threshold</th>
                                        <th>Location</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in low_stock_items %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.sku|default:'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-danger">{{ item.quantity }}</span>
                                        </td>
                                        <td>{{ item.min_quantity }}</td>
                                        <td>{{ item.location }}</td>
                                        <td>
                                            <a href="{{ item.url }}" class="btn btn-sm btn-info">
                                                <i class="fa fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                    
                    {% if report_type == 'warehouse_status' %}
                        <!-- Warehouse Status Report -->
                        <div class="mb-4">
                            <h6>Warehouse Capacity</h6>
                            <div class="progress mb-3" style="height: 25px;">
                                {% for w in warehouse_capacity %}
                                <div class="progress-bar bg-{{ w.color }}" role="progressbar" style="width: {{ w.percentage }}%" 
                                     aria-valuenow="{{ w.percentage }}" aria-valuemin="0" aria-valuemax="100" 
                                     data-bs-toggle="tooltip" title="{{ w.name }}: {{ w.percentage }}%">
                                    {{ w.name }}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="small text-muted text-end">Based on estimated capacity</div>
                        </div>
                        
                        <div class="row mb-4">
                            {% for w in warehouse_stats %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ w.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Capacity Usage</span>
                                                <span>{{ w.capacity_used }}%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-{{ w.color }}" role="progressbar" style="width: {{ w.capacity_used }}%" 
                                                     aria-valuenow="{{ w.capacity_used }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td>Racks</td>
                                                    <td>{{ w.racks }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Shelves</td>
                                                    <td>{{ w.shelves }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Bins</td>
                                                    <td>{{ w.bins }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Items</td>
                                                    <td>{{ w.items }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Total Quantity</td>
                                                    <td>{{ w.quantity }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer">
                                        <a href="{% url 'inventory:warehouse-detail' w.id %}" class="btn btn-sm btn-primary">View Details</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% if report_type == 'item_distribution' %}
                        <!-- Item Distribution Report -->
                        <div class="mb-4">
                            <div id="distribution-chart" style="height: 300px;"></div>
                        </div>
                        
                        <h6>Distribution by Category</h6>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Category</th>
                                        <th>Items</th>
                                        <th>Percentage</th>
                                        <th>Total Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cat in category_distribution %}
                                    <tr>
                                        <td>{{ cat.name }}</td>
                                        <td>{{ cat.items }}</td>
                                        <td>{{ cat.percentage }}%</td>
                                        <td>{{ cat.quantity }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <h6>Distribution by Warehouse</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Warehouse</th>
                                        <th>Items</th>
                                        <th>Percentage</th>
                                        <th>Total Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for w in warehouse_distribution %}
                                    <tr>
                                        <td>{{ w.name }}</td>
                                        <td>{{ w.items }}</td>
                                        <td>{{ w.percentage }}%</td>
                                        <td>{{ w.quantity }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                    
                    {% if not report_type %}
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> 
                            Select a report type from the options on the left to generate a report.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block inventory_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Print functionality
        document.getElementById('btn-print').addEventListener('click', function() {
            const reportContent = document.getElementById('report-container').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Inventory Report - {{ report_title }}</title>
                    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
                    <style>
                        body { padding: 20px; }
                        @media print {
                            @page { margin: 0.5cm; }
                            body { font-size: 12pt; }
                        }
                    </style>
                </head>
                <body>
                    <h2>{{ report_title }}</h2>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <hr>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(function() {
                printWindow.print();
                printWindow.close();
            }, 500);
        });
        
        // Chart initialization for item distribution report
        if (document.getElementById('distribution-chart') && '{{ report_type }}' === 'item_distribution') {
            // This is a placeholder - in a real application, you'd use a charting library
            // like Chart.js or D3.js to create a visual representation of the data
            const chart = document.getElementById('distribution-chart');
            chart.innerHTML = '<div class="alert alert-info">Distribution chart would render here using Chart.js or D3.js</div>';
        }
    });
</script>
{% endblock %}